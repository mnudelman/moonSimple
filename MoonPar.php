<?php
/**
 * https://ru.wikipedia.org/wiki/%D0%9D%D0%BE%D0%B2%D0%BE%D0%BB%D1%83%D0%BD%D0%B8%D0%B5
 * https://ru.wikipedia.org/wiki/%D0%9C%D0%B5%D1%81%D1%8F%D1%86#%D0%A1%D0%B8%D0%BD%D0%BE%D0%B4%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B9_%D0%BC%D0%B5%D1%81%D1%8F%D1%86
 * Синодический (от др.-греч. σύνοδος «соединение, сближение») месяц —
 * промежуток времени между двумя последовательными одинаковыми фазами
 * Луны (например, новолуниями).
 * среднее значение составляет 29,53058812 средних солнечных суток
 * (29 суток 12 часов 44 минуты 2,8 секунды)
 */
/**
 * таблицы из
 * http://www.astronet.ru/db/moon/moontable.html?cur_year=2019-2020&ph0=on
 *  Новолуние            Полнолуние
6 янв 2019  1:30   21 янв 2019  5:17
4 фев 2019 21:05   19 фев 2019 15:54
6 мар 2019 16:05   21 мар 2019  1:43
5 апр 2019  8:52   19 апр 2019 11:12
4 мая 2019 22:47   18 мая 2019 21:12
3 июн 2019 10:03   17 июн 2019  8:31
2 июл 2019 19:17   16 июл 2019 21:40
1 авг 2019  3:13   15 авг 2019 12:31
30 авг 2019 10:38   14 сен 2019  4:35
28 сен 2019 18:28   13 окт 2019 21:11
28 окт 2019  3:40   12 ноя 2019 13:37
26 ноя 2019 15:08   12 дек 2019  5:15
26 дек 2019  5:16   10 янв 2020 19:23
24 янв 2020 21:44    9 фев 2020  7:35
23 фев 2020 15:34    9 мар 2020 17:49
24 мар 2020  9:30    8 апр 2020  2:36
23 апр 2020  2:27    7 мая 2020 10:46
22 мая 2020 17:40    5 июн 2020 19:13
21 июн 2020  6:42    5 июл 2020  4:45
20 июл 2020 17:34    3 авг 2020 16:00
19 авг 2020  2:42    2 сен 2020  5:23
17 сен 2020 11:01    1 окт 2020 21:07
16 окт 2020 19:32   31 окт 2020 14:51
15 ноя 2020  5:09   30 ноя 2020  9:32
14 дек 2020 16:19   30 дек 2020  3:30
 * ------------------------------------------------------
 * Перигеи и Апогеи

                               9 янв 2019  4:30 406114 км
21 янв 2019 19:59 357344 км    5 фев 2019  9:28 406555 км
19 фев 2019  9:07 356761 км    4 мар 2019 11:27 406390 км
19 мар 2019 19:48 359380 км    1 апр 2019  0:15 405576 км
16 апр 2019 22:03 364208 км   28 апр 2019 18:21 404576 км
13 мая 2019 21:54 369015 км   26 мая 2019 13:28 404133 км
7 июн 2019 23:23 368506 км   23 июн 2019  7:52 404548 км
5 июл 2019  4:56 363727 км   21 июл 2019  0:02 405478 км
2 авг 2019  7:10 359397 км   17 авг 2019 10:51 406243 км
30 авг 2019 15:59 357175 км   13 сен 2019 13:33 406377 км
28 сен 2019  2:28 357802 км   10 окт 2019 18:30 405901 км
26 окт 2019 10:42 361314 км    7 ноя 2019  8:38 405059 км
23 ноя 2019  7:56 366720 км    5 дек 2019  4:10 404445 км
18 дек 2019 20:31 370258 км    2 янв 2020  1:31 404578 км
13 янв 2020 20:22 365963 км   29 янв 2020 21:29 405389 км
10 фев 2020 20:32 360463 км   26 фев 2020 11:36 406276 км
10 мар 2020  6:34 357122 км   24 мар 2020 15:24 406688 км
7 апр 2020 18:10 356908 км   20 апр 2020 19:02 406461 км
6 мая 2020  3:05 359655 км   18 мая 2020  7:46 405583 км
3 июн 2020  3:38 364365 км   15 июн 2020  0:58 404596 км
30 июн 2020  2:10 368957 км   12 июл 2020 19:28 404200 км
25 июл 2020  4:55 368366 км    9 авг 2020 13:52 404657 км
21 авг 2020 11:00 363512 км    6 сен 2020  6:32 405605 км
18 сен 2020 13:45 359080 км    3 окт 2020 17:24 406319 км
16 окт 2020 23:48 356912 км   30 окт 2020 18:47 406392 км
14 ноя 2020 11:49 357838 км   27 ноя 2020  0:30 405890 км
12 дек 2020 20:43 361776 км   24 дек 2020 16:33 405009 км
9 янв 2021 15:40 367389 км
****
 * https://ru.wikipedia.org/wiki/%D0%9E%D1%80%D0%B1%D0%B8%D1%82%D0%B0_%D0%9B%D1%83%D0%BD%D1%8B
 * Расстояние в перигее 	~362600 км
 * Расстояние в апогее 	~405400 км
 *
 * - вынужден добавить поправку $deltaSec - сдвиг даты новолуния
 *  причём при расчёте фазы это сбивает результат,т.к. в момент новолуния фаза = 0
 */
class MoonPar extends Common
{
    protected $averPeriod = 29.53058812 ;   // средний синодический месяц 29.530588853
    protected $averPeri = 362600 ;          // км средний перицентр
    protected $averApo = 405400 ;          // км средний апоцентр
    private $deltaSec = 86400 ;   //    24 * 3600 sec - сдвиг даты новолуния
//==================================================//
    /**
     * @param $parName - имя параметра
     *  вычисляется во внутренней процедуре
     * @return float|mixed|null
     */
     public function getPar($parName,$parValue = null) {
        return $this->getParClc($parName,$parValue) ;
    }

    /**
     * позорная функция. Но пока без неё не могу обойтись
     * при расчёте лунной фазы надо deltaSec = 0 , а для азимута и высоты умолчание
     * @param $partT - подстройка параметров
     */
    public function setParTuning($parT) {
        if (isset($parT['deltaSec'])) {
            $this->deltaSec = $parT['deltaSec'] ;
        }
         return $this ;
    }
    /**
     * Здесь возможны варианты выбора параметра
     * Например, обращение сразу по имени к процедуре
     * @param $parName
     */
    public function getParClc($parName,$findValue) {
        switch ($parName) {
            case 'averParm' :
                return [
                    'period' => $this->averPeriod,
                    'peri' => $this->averPeri,
                    'apo' => $this->averApo,
                ];
                break;
            case 'getPeriod' :           // таблица для опрелеония периода
                $perTab = $this->getPerTab();
                $perStartTab = $this->getPerStartTab();
                $tTest = $findValue;
                $rPer = $this->getPeriod($tTest, $perTab, $perStartTab);

                $tsBeg = strtotime($rPer['dBeg']);
                $tsEnd = strtotime($rPer['dEnd']);
                $fMoonTab = $this->fullMoonTab();
                $rFull = $this->findInTabByInterval($fMoonTab, $tsBeg, $tsEnd);
                $rPer['dMiddle'] = $fMoonTab[$rFull['i']]['date'];
                $dBeg = $rPer['dBeg'];
                $dBTf = $this->decomposeDate($dBeg);
                $h = $dBTf['h'];
//                $deltaSec = 24 * 3600;          // сутки вперёд  (кажется лучший)
//                $deltaSec = $this->deltaSec ;          //
                $perKeys = ['dBeg', 'd0', 'dEnd', 'dMiddle'];
                foreach ($rPer as $perId => $perDate) {
                    if (false !== array_search($perId, $perKeys)) {
                        $ts = strtotime($perDate) + $this->deltaSec;
                        $tf = $this->decomposeDate($ts, true);
                        $perAdd = $tf['y'] . '-' . $tf['m'] . '-' . $tf['d'] . ' ' .
                            $tf['h'] . ':' . $tf['i'] . ':' . $tf['s'];
                        $rPer[$perId] = $perAdd;
                    }
                }
                return $rPer;
                break;
            case 'getEllipsePar' :
                $periTab = $this->periTab();

                $apoTab = $this->apoTab();
                $tTest = $findValue;
                return $this->getEllipsePar($periTab, $apoTab, $tTest);
                break;
            default:
                return null;
                break;

        }

    }
    protected function getPerTab() {
        return $this->newMoonTab() ;
    }

    /**
     * таблица для определения 0-левой даты <--> 0 угол
     * для Луны она совпадает с perTab
     * @return array
     */
    protected function getPerStartTab() {
        return $this->newMoonTab() ;
    }
    /**
     * параметры эллипса: перицентр, апоцентр
     * @param $periTab = [date => rPeri,......]
     * @param $apoTab  = [date => rApo,......]
     * @param $tTest  - тестовый момент времени '2019-11-25 12:05:10'
     * @return array
     */
    protected function getEllipsePar($periTab,$apoTab,$tTest) {
        $ts  = strtotime($tTest) ;
        $r0 = [] ;
        $r0['peri'] = $this->r0FromApoPeri($periTab,$ts,$this->averPeri) ;
// апогей надо искать по интервалу дат перегея
        if (true === $r0['peri']['default']) {
            $r0['apo']['dBeg'] = '' ;
            $r0['apo']['dEnd'] = '' ;
            $r0['apo']['r'] = $this->averApo ;
            $r0['apo']['default'] = true ;
        } else {
            $ts = strtotime($r0['peri']['dBeg']) ;
            $ts1 = strtotime($r0['peri']['dEnd']) ;
            $r0['apo'] = $this->r0FromApoPeri($apoTab,$ts,$this->averApo,$ts1) ;
        }
        return $r0 ;
    }

    /**
     * вытащить параметр эллипса (apo | peri)
     * @param $tab  - таблица apoTab | periTab
     * @param $ts   - тестовый момент времени
     * @param $defaultValue  - значение по умолчанию
     */
    protected function r0FromApoPeri($tab, $ts, $defaultValue,$ts1 = false) {
        if (false === $ts1) {
            $tsi = $this->findInTab($tab,$ts) ;
        }else {
            $tsi = $this->findInTabByInterval($tab,$ts,$ts1) ;
        }

        $res = ['dBeg' => '','dEnd' => '','r' => 0,'default' => false] ;
        if (false === $tsi) {
            $res['r'] = $defaultValue ;
            $res['default'] = true ;
        }else {
            $iTab = $tsi['i'] ;
            $r = $tab[$iTab]['val'] ;
            $dateBeg = $tab[$iTab]['date'] ;
//  если был интервал, то найден едиственный элемент
            $dateEnd = (false === $ts1) ? $tab[$iTab +1]['date'] : $dateBeg ;
            $res['dBeg'] = $dateBeg ;
            $res['dEnd'] = $dateEnd ;
            $res['r'] = $r ;
        }
        return $res ;

    }
    /**
     * параметры текущего периода прохождения орбиты
     * @param $perTab - таблица периодов (пример новолуние для Луны | перигелий для Земли)
     * @param $perStartTab - таблица для определения начального момента
     * @param $tStr - это тестовая дата для определения периода
     * @return array
     */
    protected function getPeriod($tStr,$perTab,$perStartTab = null) {
        $ts  = strtotime($tStr) ;
        $r0 = [
            'dBeg' => $tStr,
            'dEnd' => $tStr,
            'd0' => '',           // дата отсчёта угла поворота (для Луны новолуние)
            'T' => 0.00,          // дней
            'default' => false,   // выбор из таблицы иначе среднее
        ] ;
        $per = $this->findInTab($perTab,$ts) ;
        $perStart = null ;
        if (!is_null($perStartTab)) {
            $tsBeg = $per['tsBeg'] ;
            $tsEnd = $per['tsEnd'] ;
            $perStart = $this->findInTabByInterval($perStartTab,$tsBeg,$tsEnd) ;
        }
        if (false === $per) {
            $r0['default'] = true ;
            $r0['T'] = $this->averPeriod ;
        }else {
            $tsBeg = $per['tsBeg'] ;
            $tsEnd = $per['tsEnd'] ;
            $iTab = $per['i'] ;
            $r0['dBeg'] = $perTab[$iTab]['date'] ;
            $r0['dEnd'] = $perTab[$iTab + 1]['date'] ;
            $r0['d0'] = $perTab[$iTab]['date'] ;
            if (!is_null($perStart)) {              // из другой таблицы
                $iTab = $perStart['i'] ;
                $r0['d0'] = $perStartTab[$iTab]['date'] ;
            }

            $tPer = ($tsEnd - $tsBeg) / (24 * 3600) ;

//            $tPer = $this->averPeriod ;

            $r0['T'] = round($tPer,6) ; // суток
            $r0['default'] = false ;

        }
        return $r0 ;
    }

    /**
     * поиск временного интервала в таблице $tab для тестового $ts
     * @param $tab  = [ts => ....]    ts - ключ
     * @param $ts
     * @return array|bool
     */
    protected function findInTab($tab,$ts) {
        $iBeg = false ;
        $tsBeg = false ;
        $tsEnd = false ;
        $r = false ;
        for ($i = 0; $i < sizeof($tab) - 1; $i++) {
            $tsBeg = $tab[$i]['ts'] ;
            $tsEnd =  $tab[$i+1]['ts'] ;
            if ($tsBeg <= $ts && $ts <= $tsEnd) {
               $iBeg = $i ;
               break ;
            }
        }
        if ($iBeg !== false) {
            $r = [
                'i' => $iBeg,
                'tsBeg' => $tsBeg,
                'tsEnd' => $tsEnd,
            ];
        }else {
            $r = false ;
        }
        return $r ;
    }

    /**
     * айти строчку по интервалу
     * Использовать, например, когда надо найти равноденствие по
     * текущему году
     * @param $tab
     * @param $ts1
     * @param $ts2
     * @return array|bool
     */
    protected function findInTabByInterval($tab,$ts1,$ts2) {
        $iBeg = false ;
        $ts = false ;
        $r = false ;
        for ($i = 0; $i < sizeof($tab) - 1; $i++) {
            $ts = $tab[$i]['ts'] ;
            if ($ts <= $ts2 && $ts >= $ts1) {
                $iBeg = $i ;
                break ;
            }
        }
        if ($iBeg !== false) {
            $r = [
                'i' => $iBeg,
                'ts' => $ts,
            ];
        }else {
            $r = false ;
        }
        return $r ;
    }

    /**
     * таблица новолуний
     * @return mixed
     */
    private function newMoonTab() {
        $newMoonTab = [
            '2019-01-6 1:30',
            '2019-02-4 21:05',
            '2019-03-6 16:05',
            '2019-04-5 8:52',
            '2019-05-4 22:47',
            '2019-06-3 10:03',
            '2019-07-2 19:17',
            '2019-08-1 3:13',
            '2019-08-30 10:38',
            '2019-09-28 18:28',
            '2019-10-28 3:40',
            '2019-11-26 15:08',
            '2019-12-26 5:16',
            '2020-01-24 21:44',
            '2020-02-24 15:34',
            '2020-03-24 9:30',
            '2020-04-23 2:27',
            '2020-05-22 17:40',
            '2020-06-21 6:42',
            '2020-07-20 17:34',
            '2020-08-19 2:42',
            '2020-09-17 11:01',

            '2020-10-16 19:32',     // !!!!!!!!!!!
            '2020-11-15 5:09',
            '2020-12-14 16:19',
            '2021-01-13 5:00',
        ] ;
        $keyTab = $this->transferToKeyArr($newMoonTab) ;
        return $this->addTimestamp($keyTab) ;
    }

    /**
     * таблица полнолуний
     * @return mixed
     */
    private function fullMoonTab() {
        $fullMoonTab = [
            '2019-01-21 5:17',
            '2019-02-19 15:54',
            '2019-03-21 1:43',
            '2019-04-19 11:12',
            '2019-05-18 21:12',
            '2019-06-17 8:31',
            '2019-07-16 21:40',
            '2019-08-15 12:31',
            '2019-09-14 4:35',
            '2019-10-13 21:11',
            '2019-11-12 13:37',
            '2019-12-12 5:15',
            '2020-01-10 19:23',
            '2020-02-9 7:35',
            '2020-03-9 17:49',
            '2020-04-8 2:36',

            '2020-05-7 10:46',
//            '2020-05-8 10:46',

            '2020-06-5 19:13',
            '2020-07-5 4:45',
            '2020-08-3 16:00',
            '2020-09-2 5:23',
            '2020-10-1 21:07',
            '2020-10-31 14:51',
            '2020-11-30 9:32',
            '2020-12-30 3:30'

        ] ;
        $keyTab = $this->transferToKeyArr($fullMoonTab) ;
        return $this->addTimestamp($keyTab) ;
    }

    /**
     * добавляет столбец ts - timestamp - метка времени
     * @param $dTab - таблица с ключевым столбцом dKey = '2019-11-23 10:05:20'
     * @return mixed
     */
    protected function addTimestamp($dTab,$oneColumnFlag = false) {
        $tabNew = [] ;
        foreach ($dTab as $dKey => $value) {
            if ($oneColumnFlag) {
                $ts = strtotime($value) ;
                $tabNew[] =
                    ['ts' => $ts,'date' => $value] ;
            }else {
                $ts = strtotime($dKey) ;
                $tabNew[] =
                    ['ts' => $ts,'date' => $dKey,'val' => $value] ;
            }
            }

        return $tabNew ;
    }

    /**
     * преобразовать в массив с ключами
     * это для одномерного массива дат ['2019-12-25 10:05:15',....]
     * преобразовать в массив ['2019-12-25 10:05:15' => '',......]
     * @param $arr
     * @return array
     */
    protected function transferToKeyArr($arr) {
        $keyTab = [] ;
        for ($i = 0; $i < sizeof($arr); $i++) {
            $keyTab[$arr[$i]] = '' ;
        }
        return $keyTab ;
    }
    protected function periTab() {
        $periTab = [
            '2019-01-21 19:59' => 357344,
           '2019-02-19 9:07' => 356761,
           '2019-03-19 19:48' => 359380,
           '2019-04-16 22:03' => 364208,
           '2019-05-13 21:54' => 369015,
           '2019-06-7 23:23' => 368506,
           '2019-07-5 4:56' => 363727,
           '2019-08-2 7:10' => 359397,
           '2019-08-30 15:59' => 357175,
           '2019-09-28 2:28' => 357802,
           '2019-10-26 10:42' => 361314,
           '2019-11-23 7:56' => 366720,
           '2019-12-18 20:31' => 370258,
           '2020-01-13 20:22' => 365963,
           '2020-02-10 20:32' => 360463,
           '2020-03-10 6:34' => 357122,
           '2020-04-7 18:10' => 356908,
           '2020-05-6 3:05' => 359655,
           '2020-06-3 3:38' => 364365,
           '2020-06-30 2:10' => 368957,
           '2020-07-25 4:55' => 368366,
           '2020-08-21 11:00' => 363512,
           '2020-09-18 13:45' => 359080,
           '2020-10-16 23:48' => 356912,
           '2020-11-14 11:49' => 357838,
           '2020-12-12 20:43' => 361776,
           '2021-01-9 15:40' => 367389,
        ] ;
        return $this->addTimestamp($periTab) ;
    }
    protected function apoTab() {
        $apoTab = [
            '2019-01-9 4:30' => 406114,
            '2019-02-5 9:28' => 406555,
            '2019-03-4 11:27' => 406390,
            '2019-04-1 0:15' => 405576,
            '2019-04-28 18:21' => 404576,
            '2019-05-26 13:28' => 404133,
            '2019-06-23 7:52' => 404548,
            '2019-07-21 0:02' => 405478,
            '2019-08-17 10:51' => 406243,
            '2019-09-13 13:33' => 406377,
            '2019-10-10 18:30' => 405901,
            '2019-11-7 8:38' => 405059,
            '2019-12-5 4:10' => 404445,
            '2020-01-2 1:31' => 404578,
            '2020-01-29 21:29' => 405389,
            '2020-02-26 11:36' => 406276,
            '2020-03-24 15:24' => 406688,
            '2020-04-20 19:02' => 406461,
            '2020-05-18 7:46' => 405583,
            '2020-06-15 0:58' => 404596,
            '2020-07-12 19:28' => 404200,
            '2020-08-9 13:52' => 404657,
            '2020-09-6 6:32' => 405605,
            '2020-10-3 17:24' => 406319,
            '2020-10-30 18:47' => 406392,
            '2020-11-27 0:30' => 405890,
            '2020-12-24 16:33' => 405009,
        ] ;
        return $this->addTimestamp($apoTab) ;
    }
}